"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[310],{4310:function(e,t,r){r.d(t,{AppStateProvider:function(){return b},pJ:function(){return N},mX:function(){return C},NK:function(){return i},mr:function(){return m}});var a=r(7437),u=r(2265),s=r(7188);function n(e,t){let r=(0,s.ri)(),a={};for(let u=1;u<=t;u++){let t=e[u],s=r.menus.find(e=>e.id===t);a[u]=(null==s?void 0:s.courses)||[]}let u=Math.max(...Object.values(a).map(e=>e.length),0),n=[];for(let e=0;e<u;e++){let r={};for(let u=1;u<=t;u++)r[u]=a[u][e]||"";let u=r[1]||Object.values(r).find(e=>!!e)||"Course ".concat(e+1),s={};for(let e=1;e<=t;e++)s[e]="";n.push({id:"c_".concat(e+1,"_").concat(Date.now().toString(16),"_").concat(Math.random().toString(36).slice(2)),idx:e+1,name:u,seatDish:r,status:"PENDING",seatSubs:s,refireCount:0,hasRefired:!1})}return n}function l(e){return e.map((e,t)=>({...e,idx:t+1}))}function i(e){return["A","B","C","D","E","F","G","H"].slice(0,Math.max(1,Math.min(8,e||1)))}function d(e){var t;let r={};for(let t=1;t<=e;t++)r[t]="";let a=(null===(t=(0,s.ri)().menus[0])||void 0===t?void 0:t.id)||"m_a",u=Object.fromEntries(Array.from({length:e},(e,t)=>[t+1,a]));return{menuId:a,pairing:!1,paused:!1,allergiesBySeat:r,approval:"NONE",approvedAt:void 0,seatMenuId:u,courseLines:n(u,e),wineOverrideByCourseId:{},fohNote:"",wineMenuPassed:!1,wineOrdered:!1,chefNote:"",extrasByCourseId:{},lastFireAt:void 0,lastFiredAt:void 0,lastDoneAt:void 0,pausedAt:void 0,lastFiredCourseId:void 0,pausedAfterLastFire:!1}}let o=new Date().toISOString().slice(0,10),p=[{id:"r1",name:"Tanaka",pax:4,time:"20:00",note:"Shellfish allergy (Seat 3)",reservationNote:"Shellfish allergy (Seat 3)",language:"EN",date:o,service:"DINNER",status:"BOOKED",channel:"online",tags:["VIP"],draftStatus:"NONE",draftSetup:null,draftMenuId:"m_a",draftGuestMenuId:{},draftGuestMenuMap:{},sentToApproval:!1},{id:"r2",name:"Jenkins",pax:2,time:"20:15",note:"Anniversary",reservationNote:"Anniversary",language:"ES",date:o,service:"DINNER",status:"BOOKED",channel:"phone",draftStatus:"NONE",draftSetup:null,draftMenuId:"m_a",draftGuestMenuId:{},draftGuestMenuMap:{},sentToApproval:!1},{id:"r3",name:"Roquefort",pax:6,time:"20:30",note:"Quiet table",reservationNote:"Quiet table",language:"FR",date:o,service:"DINNER",status:"BOOKED",channel:"covermanager",tags:["VIP"],draftStatus:"NONE",draftSetup:null,draftMenuId:"m_a",draftGuestMenuId:{},draftGuestMenuMap:{},sentToApproval:!1}],f=[{id:1,name:"T1",pax:0,status:"EMPTY",x:80,y:80},{id:2,name:"T2",pax:0,status:"EMPTY",x:280,y:80},{id:3,name:"T3",pax:0,status:"EMPTY",x:480,y:80},{id:4,name:"T4",pax:0,status:"EMPTY",x:80,y:260},{id:5,name:"T5",pax:0,status:"EMPTY",x:280,y:260}],c=u.createContext(null);function v(e){return"function"==typeof structuredClone?structuredClone(e):JSON.parse(JSON.stringify(e))}function S(e,t){var r;let a=null===(r=(e||"").split("\n")[0])||void 0===r?void 0:r.trim();return a&&a.length>0?a:t}function E(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(0===t.length)return e;let a=e.courseLines.map(e=>{let a=t.filter(t=>t.courseId===e.id);if(0===a.length)return e;let u={...e.seatSubs||{}};for(let e of a){let t=r[e.guest];t&&(u[t]=e.text)}return{...e,seatSubs:u}});return{...e,courseLines:a}}function I(e){var t,r;let a=e.pax||0,u=(null===(t=(0,s.ri)().menus[0])||void 0===t?void 0:t.id)||"m_a",l=e.draftMenuId||u,d=i(a),o=e.draftGuestSeatMap||{},p={};for(let e=1;e<=a;e++)p[e]=d[e-1];for(let[e,t]of Object.entries(o))t&&t>=1&&t<=a&&(p[t]=e);let f={};for(let t=1;t<=a;t++){let a=p[t],s=null===(r=e.draftGuestMenuId)||void 0===r?void 0:r[a];f[t]=s||l||u}let c={};for(let e=1;e<=a;e++)c[e]="";let v=(e.allergies||"").trim();return E({menuId:f[1]||l||u,pairing:!1,paused:!1,allergiesBySeat:c,approval:"NONE",approvedAt:void 0,seatMenuId:f,courseLines:n(f,a),wineOverrideByCourseId:{},fohNote:v?"Allergies: ".concat(v):"",wineMenuPassed:!1,wineOrdered:!1,chefNote:"",extrasByCourseId:{}},e.draftGuestSubs||[],e.draftGuestSeatMap||{})}function b(e){let{children:t}=e,[r,o]=u.useState(p),[b,m]=u.useState(f),C=(0,s.ri)(),N=C.subsPresets,A=C.dishPresets,[T,h]=u.useState("DISCONNECTED"),[y,O]=u.useState("OFF"),D=u.useRef(null),g=u.useRef("OFF"),M=u.useRef([]),_=u.useRef([]),L=u.useRef(null);u.useEffect(()=>{M.current=b},[b]),u.useEffect(()=>{_.current=r},[r]);let k=u.useCallback(()=>M.current,[]),x=u.useCallback(()=>_.current,[]),G=u.useCallback(e=>_.current.find(t=>t.id===e)||null,[]),w=u.useCallback(e=>{let t=_.current.find(t=>t.id===e);return t?{setup:t.draftSetup,subs:t.draftGuestSubs||[],map:t.draftGuestSeatMap||{},menuId:t.draftMenuId}:null},[]);function P(e){return JSON.parse(JSON.stringify(e))}function R(e,t,r,a,u){let s=P(e);if(!a||0===a.length)return s;let n={};for(let e of((null==u?void 0:u.courseLines)&&u.courseLines.forEach(e=>{e.id&&(n[e.id]=e.idx)}),a)){let t=null==r?void 0:r[e.guest];if(!t||t<1)continue;let a=s.courseLines.find(t=>t.id===e.courseId);if(!a&&n[e.courseId]){let t=n[e.courseId];a=s.courseLines.find(e=>e.idx===t)}a&&(a.seatSubs||(a.seatSubs={}),a.seatSubs[t]=e.text)}return s}let F=u.useCallback((e,t)=>{var r;if(!(null==e?void 0:e.draftSetup))return null;let a=v(e.draftSetup),u=e.draftMenuId||a.menuId||(null===(r=(0,s.ri)().menus[0])||void 0===r?void 0:r.id)||"m_a",l=i(t),d={};for(let e=1;e<=t;e++)d[e]=l[e-1];for(let[r,a]of Object.entries(e.draftGuestSeatMap||{}))a&&a>=1&&a<=t&&(d[a]=r);let o={},p={...e.draftGuestMenuMap||{},...e.draftGuestMenuId||{}};for(let e=1;e<=t;e++){let t=d[e];o[e]=p[t]||u}let f=R(function(e,t,r,a){let u=P(e),l=u.menuId,d=i(t);(0,s.ri)().menus;let o=new Map,p=e=>{if(o.has(e))return o.get(e);let r=function(e,t){var r;let a={};for(let e=1;e<=t;e++)a[e]="";let u=e||(null===(r=(0,s.ri)().menus[0])||void 0===r?void 0:r.id)||"m_a",l=Object.fromEntries(Array.from({length:t},(e,t)=>[t+1,u]));return{menuId:u,pairing:!1,paused:!1,allergiesBySeat:a,approval:"NONE",approvedAt:void 0,seatMenuId:l,courseLines:n(l,t),wineOverrideByCourseId:{},fohNote:"",wineMenuPassed:!1,wineOrdered:!1,chefNote:"",extrasByCourseId:{}}}(e,t);return o.set(e,r),r};for(let e of d){let t=null==r?void 0:r[e];if(!t||t<1)continue;let s=(null==a?void 0:a[e])||l;if(!s||s===l)continue;let n=p(s);for(let e of u.courseLines){let r=n.courseLines.find(t=>t.idx===e.idx);r&&(e.seatDish||(e.seatDish={}),e.seatDish[t]=r.name)}}return u}(a,t,e.draftGuestSeatMap||{},p),t,e.draftGuestSeatMap||{},e.draftGuestSubs||[],e.draftSetup);return{...f,seatMenuId:o,menuId:o[1]||f.menuId}},[]),B=u.useCallback(e=>{m(e.tables||[]),o(e.reservations||[])},[]),U=u.useCallback(()=>{"HOST"===g.current&&D.current&&(L.current&&clearTimeout(L.current),L.current=setTimeout(()=>{var e,t;let r={tables:(t={tables:k(),reservations:x()}).tables,reservations:t.reservations};null===(e=D.current)||void 0===e||e.send({type:"SNAPSHOT",payload:r})},60))},[x,k]);u.useEffect(()=>{U()},[r,U]);let V=u.useCallback((e,t)=>{m(r=>r.map(r=>{var a;if(r.id!==e)return r;let u=null!==(a=r.setup)&&void 0!==a?a:d(r.pax||0);return{...r,setup:{...u,...t}}}))},[]),j=u.useCallback((e,t)=>{m(r=>r.map(r=>{var a;if(r.id!==e)return r;let u=null!==(a=r.setup)&&void 0!==a?a:d(r.pax||0),s=r.pax||0,l=Object.fromEntries(Array.from({length:s},(e,r)=>[r+1,t]));return{...r,setup:{...u,menuId:t,seatMenuId:l,courseLines:n(l,s),lastFireAt:void 0,lastFiredCourseId:void 0,pausedAfterLastFire:!1}}}))},[]),H=u.useCallback((e,t,r)=>{m(a=>a.map(a=>{if(a.id!==e||!a.setup)return a;let u=a.pax||0,s={...a.setup.seatMenuId||{}};s[t]=r;let l=n(s,u);for(let e of l){let t=a.setup.courseLines.find(t=>t.idx===e.idx);t&&(e.status=t.status,e.refireCount=t.refireCount,e.hasRefired=t.hasRefired,e.seatSubs=t.seatSubs)}return{...a,setup:{...a.setup,menuId:1===t?r:a.setup.menuId,seatMenuId:s,courseLines:l}}}))},[m]),J=u.useCallback((e,t)=>{V(e,{pairing:t})},[V]),X=u.useCallback((e,t)=>{let r=e.draftSetup?v(e.draftSetup):null;r&&(r.approval="NONE",r.approvedAt=void 0),m(a=>a.map(a=>a.id!==t?a:{...a,reservationStatus:"ASSIGNED",reservationId:e.id,reservationName:e.name,reservationNote:e.reservationNote||e.note||"",reservationPax:e.pax,reservationTime:e.time,setup:r||a.setup}))},[m]),K=u.useCallback(e=>{let t=Date.now();m(r=>r.map(r=>{var a,u,s,n,l;if(r.id!==e||"ASSIGNED"!==r.reservationStatus)return r;let i=null!==(u=null!==(a=r.reservationPax)&&void 0!==a?a:r.pax)&&void 0!==u?u:0,o=_.current.find(e=>e.id===r.reservationId),p=(null==o?void 0:o.draftSetup)?v(o.draftSetup):null;return p&&(p.approval="NONE",p.approvedAt=void 0),{...r,reservationStatus:"SEATED",status:"SEATED",pax:i,seatedAt:null!==(s=r.seatedAt)&&void 0!==s?s:t,lastActionAt:t,setup:null!==(l=null!==(n=r.setup)&&void 0!==n?n:p)&&void 0!==l?l:d(i)}}))},[m]),Y=u.useCallback(e=>{m(t=>t.map(t=>t.id!==e?t:{...t,reservationStatus:"NONE",reservationId:void 0,reservationName:void 0,reservationNote:void 0,reservationPax:void 0,reservationTime:void 0,status:"EMPTY",setup:void 0}))},[m]),Q=u.useCallback((e,t)=>{o(r=>r.map(r=>r.id===e?{...r,...t}:r))},[]),W=u.useCallback((e,t)=>{o(r=>r.map(r=>r.id===e?{...r,reservationNote:t}:r))},[]),z=u.useCallback(e=>{var t,r,a,u,n,l,i,d,p,f,c,v;let S={...e,draftStatus:null!==(r=e.draftStatus)&&void 0!==r?r:"NONE",draftSetup:null!==(a=e.draftSetup)&&void 0!==a?a:null,draftMenuId:null!==(n=null!==(u=e.draftMenuId)&&void 0!==u?u:null===(t=(0,s.ri)().menus[0])||void 0===t?void 0:t.id)&&void 0!==n?n:"m_a",draftGuestSubs:null!==(l=e.draftGuestSubs)&&void 0!==l?l:[],draftGuestSeatMap:null!==(i=e.draftGuestSeatMap)&&void 0!==i?i:{},draftGuestMenuId:null!==(d=e.draftGuestMenuId)&&void 0!==d?d:{},draftGuestMenuMap:null!==(p=e.draftGuestMenuMap)&&void 0!==p?p:{},reservationNote:null!==(c=null!==(f=e.reservationNote)&&void 0!==f?f:e.note)&&void 0!==c?c:"",sentToApproval:null!==(v=e.sentToApproval)&&void 0!==v&&v};o(e=>[S,...e])},[]),q=u.useCallback(e=>{o(t=>t.filter(t=>t.id!==e))},[]),$=u.useCallback((e,t)=>{let r=String(e);o(e=>e.map(e=>e.id===r?t(e):e))},[]),Z=u.useCallback(e=>{$(e,e=>{var t,r,a,u,s;let n=I(e),l=e.draftMenuId||n.menuId;return{...e,draftStatus:"DRAFT",draftSetup:n,draftMenuId:l,draftGuestSubs:null!==(t=e.draftGuestSubs)&&void 0!==t?t:[],draftGuestSeatMap:null!==(r=e.draftGuestSeatMap)&&void 0!==r?r:{},draftGuestMenuId:null!==(a=e.draftGuestMenuId)&&void 0!==a?a:{},draftGuestMenuMap:null!==(u=e.draftGuestMenuMap)&&void 0!==u?u:{},sentToApproval:null!==(s=e.sentToApproval)&&void 0!==s&&s,draftUpdatedAt:Date.now()}})},[$]),ee=u.useCallback(e=>{$(e,e=>({...e,draftStatus:"PREPPED",draftUpdatedAt:Date.now()}))},[$]),et=u.useCallback(e=>{$(e,e=>({...e,draftStatus:"NONE",draftSetup:null,draftGuestSubs:[],draftGuestSeatMap:{},draftGuestMenuId:{},draftGuestMenuMap:{},sentToApproval:!1,draftUpdatedAt:Date.now()}))},[$]),er=u.useCallback((e,t,r,a)=>{let u=(a||"").trim();u&&$(e,e=>{var a,s;let n=null!==(s=e.draftSetup)&&void 0!==s?s:I(e),i=[...n.courseLines],d=i.findIndex(e=>e.id===t);if(d<0)return e;let o={id:"c_ins_".concat(Math.random().toString(36).slice(2),"_").concat(Date.now().toString(16)),idx:0,name:u,status:"PENDING",seatDish:Object.fromEntries(Array.from({length:e.pax||0},(e,t)=>[t+1,u])),seatSubs:{...(null===(a=i[0])||void 0===a?void 0:a.seatSubs)||{}},refireCount:0,hasRefired:!1};i.splice("BEFORE"===r?d:d+1,0,o);let p={...n,courseLines:l(i)};return{...e,draftStatus:e.draftStatus&&"NONE"!==e.draftStatus?e.draftStatus:"DRAFT",draftSetup:p,draftUpdatedAt:Date.now()}})},[$]),ea=u.useCallback((e,t)=>{$(e,e=>{if(!e.draftSetup)return e;let r=e.draftSetup.courseLines.filter(e=>e.id!==t),a={...e.draftSetup,courseLines:l(r)};return{...e,draftSetup:a,draftUpdatedAt:Date.now()}})},[$]),eu=u.useCallback((e,t,r)=>{$(e,e=>{if(!e.draftSetup)return e;let a=[...e.draftSetup.courseLines],u=a.findIndex(e=>e.id===t);if(u<0)return e;let s=u+r;if(s<0||s>=a.length)return e;[a[u],a[s]]=[a[s],a[u]];let n={...e.draftSetup,courseLines:l(a)};return{...e,draftSetup:n,draftUpdatedAt:Date.now()}})},[$]),es=u.useCallback((e,t,r,a)=>{$(e,e=>{if(!e.draftSetup)return e;let u=e.draftSetup;return{...e,draftSetup:{...u,courseLines:u.courseLines.map(e=>e.id!==t?e:{...e,seatSubs:{...e.seatSubs,[r]:a}})},draftUpdatedAt:Date.now()}})},[$]),en=u.useCallback((e,t,r)=>{let a=(r||"").trim();a&&$(e,e=>{if(!e.draftSetup)return e;let r={...e.draftSetup.extrasByCourseId||{}},u=[...r[t]||[]];return u.push(a),r[t]=u,{...e,draftSetup:{...e.draftSetup,extrasByCourseId:r},draftUpdatedAt:Date.now()}})},[$]),el=u.useCallback((e,t,r)=>{$(e,e=>{if(!e.draftSetup)return e;let a={...e.draftSetup.extrasByCourseId||{}},u=[...a[t]||[]];return r<0||r>=u.length?e:(u.splice(r,1),a[t]=u,{...e,draftSetup:{...e.draftSetup,extrasByCourseId:a},draftUpdatedAt:Date.now()})})},[$]),ei=u.useCallback((e,t)=>{$(e,e=>e.draftSetup?{...e,draftSetup:{...e.draftSetup,chefNote:t},draftUpdatedAt:Date.now()}:e)},[$]),ed=u.useCallback((e,t,r)=>{m(a=>a.map(a=>{if(a.id!==e||!a.setup)return a;let u=a.setup.courseLines.map(e=>e.id!==t?e:{...e,displayText:r,name:S(r,e.name||"Course ".concat(e.idx))});return{...a,setup:{...a.setup,courseLines:u}}}))},[m]),eo=u.useCallback((e,t,r)=>{m(a=>a.map(a=>{if(a.id!==e||!a.setup)return a;let u=[...a.setup.courseLines],s=u.findIndex(e=>e.id===t);if(s<0)return a;let n=s+r;return n<0||n>=u.length?a:([u[s],u[n]]=[u[n],u[s]],{...a,setup:{...a.setup,courseLines:l(u)}})}))},[m]),ep=u.useCallback((e,t)=>{m(r=>r.map(r=>{if(r.id!==e||!r.setup)return r;let a=r.setup.courseLines.filter(e=>e.id!==t);return{...r,setup:{...r.setup,courseLines:l(a)}}}))},[m]),ef=u.useCallback((e,t,r)=>{let a=(r||"").trim()||"New course";m(r=>r.map(r=>{var u;if(r.id!==e||!r.setup)return r;let s=[...r.setup.courseLines],n={id:"c_k_".concat(Math.random().toString(36).slice(2),"_").concat(Date.now().toString(16)),idx:0,name:S(a,"New course"),displayText:a,status:"PENDING",seatDish:Object.fromEntries(Array.from({length:r.pax||0},(e,t)=>[t+1,S(a,"New course")])),seatSubs:{...(null===(u=s[0])||void 0===u?void 0:u.seatSubs)||{}},refireCount:0,hasRefired:!1};if(t){let e=s.findIndex(e=>e.id===t);e<0?s.push(n):s.splice(e+1,0,n)}else s.push(n);return{...r,setup:{...r.setup,courseLines:l(s)}}}))},[m]),ec=u.useCallback((e,t,r,a)=>{let u=(a||"").trim();u&&$(e,e=>{let a={...e},s=Array.isArray(a.draftGuestSubs)?[...a.draftGuestSubs]:[],n="undefined"!=typeof crypto&&"randomUUID"in crypto?crypto.randomUUID():"dsub_".concat(Math.random().toString(36).slice(2),"_").concat(Date.now().toString(16));return s.push({id:n,courseId:t,guest:r,text:u}),a.draftGuestSubs=s,a.draftUpdatedAt=Date.now(),a})},[$]),ev=u.useCallback((e,t)=>{$(e,e=>{let r={...e};return r.draftGuestSubs=(r.draftGuestSubs||[]).filter(e=>e.id!==t),r.draftUpdatedAt=Date.now(),r})},[$]),eS=u.useCallback((e,t,r)=>{$(e,e=>{let a={...e},u={...a.draftGuestSeatMap||{}};return!r||r<1?delete u[t]:u[t]=r,a.draftGuestSeatMap=u,a.draftUpdatedAt=Date.now(),a})},[$]),eE=u.useCallback((e,t,r)=>{$(e,e=>{let a={...e},u={...a.draftGuestMenuMap||{}},s={...a.draftGuestMenuId||{}};return r?(u[t]=r,s[t]=r):(delete u[t],delete s[t]),a.draftGuestMenuMap=u,a.draftGuestMenuId=s,a.draftUpdatedAt=Date.now(),a})},[$]),eI=u.useCallback((e,t,r)=>{o(a=>a.map(a=>{if(a.id!==e)return a;let u={...a.draftGuestMenuId||{}};u[t]=r;let s={...a,draftGuestMenuId:u},n=I(s);return{...s,draftSetup:n}}))},[]),eb=u.useCallback((e,t,r)=>{$(e,e=>{if(!e.draftSetup)return e;let a=e.draftSetup.courseLines.map(e=>e.id!==t?e:{...e,displayText:r,name:S(r,e.name||"Course ".concat(e.idx))});return{...e,draftSetup:{...e.draftSetup,courseLines:a},draftUpdatedAt:Date.now()}})},[$]),em=u.useCallback((e,t,r)=>{let a=(r||"").trim()||"New course";$(e,e=>{var r,u;let s=null!==(u=e.draftSetup)&&void 0!==u?u:I(e),n=[...s.courseLines],i=S(a,"New course"),d={id:"c_d_".concat(Math.random().toString(36).slice(2),"_").concat(Date.now().toString(16)),idx:0,name:i,displayText:a,status:"PENDING",seatDish:Object.fromEntries(Array.from({length:e.pax||0},(e,t)=>[t+1,i])),seatSubs:{...(null===(r=n[0])||void 0===r?void 0:r.seatSubs)||{}},refireCount:0,hasRefired:!1};if(t){let e=n.findIndex(e=>e.id===t);e<0?n.push(d):n.splice(e+1,0,d)}else n.push(d);let o={...s,courseLines:l(n)};return{...e,draftStatus:e.draftStatus&&"NONE"!==e.draftStatus?e.draftStatus:"DRAFT",draftSetup:o,draftUpdatedAt:Date.now()}})},[$]),eC=u.useCallback((e,t)=>{o(r=>r.map(r=>{if(r.id!==e)return r;let a={...r,draftMenuId:t},u=I(a);return{...a,draftSetup:u}}))},[]),eN=u.useCallback((e,t)=>{if(!["ING","CAST","CAT"].includes(t))return;let r=Date.now();m(a=>a.map(a=>{var u,s,n,l,i;if(a.id!==e)return a;let o=a.reservationId?_.current.find(e=>e.id===a.reservationId):null,p=null!==(s=null!==(u=a.reservationPax)&&void 0!==u?u:a.pax)&&void 0!==s?s:0,f=(null==o?void 0:o.draftSetup)?v(o.draftSetup):null;f&&(f.approval="NONE",f.approvedAt=void 0);let c=null!==(l=null!==(n=a.setup)&&void 0!==n?n:f)&&void 0!==l?l:d(p),S="ASSIGNED"===a.reservationStatus;return{...a,tableLanguage:t,language:t,reservationStatus:S?"SEATED":a.reservationStatus,status:S?"SEATED":a.status,pax:S?p:a.pax,seatedAt:S?null!==(i=a.seatedAt)&&void 0!==i?i:r:a.seatedAt,lastActionAt:r,setup:S?c:a.setup}}))},[m]),eA=u.useCallback((e,t)=>{m(r=>r.map(r=>r.id===e&&r.setup?{...r,setup:{...r.setup,chefNote:t}}:r))},[m]),eT=u.useCallback((e,t,r)=>{let a=(r||"").trim();a&&m(r=>r.map(r=>{if(r.id!==e||!r.setup)return r;let u={...r.setup.extrasByCourseId||{}},s=[...u[t]||[]];return s.push(a),u[t]=s,{...r,setup:{...r.setup,extrasByCourseId:u}}}))},[m]),eh=u.useCallback((e,t,r)=>{m(a=>a.map(a=>{if(a.id!==e||!a.setup)return a;let u={...a.setup.extrasByCourseId||{}},s=[...u[t]||[]];return r<0||r>=s.length?a:(s.splice(r,1),u[t]=s,{...a,setup:{...a.setup,extrasByCourseId:u}})}))},[m]),ey=u.useCallback((e,t,r,a)=>{let u=(a||"").trim();u&&m(a=>a.map(a=>{var s;if(a.id!==e||!a.setup)return a;let n=[...a.setup.courseLines],i=n.findIndex(e=>e.id===t);if(i<0)return a;let d={id:"c_ins_".concat(Math.random().toString(36).slice(2),"_").concat(Date.now().toString(16)),idx:0,name:u,status:"PENDING",seatDish:Object.fromEntries(Array.from({length:a.pax||0},(e,t)=>[t+1,u])),seatSubs:{...(null===(s=n[0])||void 0===s?void 0:s.seatSubs)||{}},refireCount:0,hasRefired:!1};n.splice("BEFORE"===r?i:i+1,0,d);let o={...a.setup,courseLines:l(n)};return{...a,setup:o}}))},[m]),eO=u.useCallback((e,t)=>{m(r=>r.map(r=>{if(r.id!==e||!r.setup)return r;let a=r.setup.courseLines.filter(e=>e.id!==t),u={...r.setup,courseLines:l(a)};return{...r,setup:u}}))},[m]),eD=u.useCallback((e,t,r)=>{m(a=>a.map(a=>{if(a.id!==e||!a.setup)return a;let u=[...a.setup.courseLines],s=u.findIndex(e=>e.id===t);if(s<0)return a;let n=s+r;if(n<0||n>=u.length)return a;[u[s],u[n]]=[u[n],u[s]];let i={...a.setup,courseLines:l(u)};return{...a,setup:i}}))},[m]),eg=u.useCallback((e,t)=>{let r=Date.now();m(a=>a.map(a=>{var u,s;if(a.id!==e)return a;let n=null!==(u=a.setup)&&void 0!==u?u:d(a.pax||0),l=!n.paused&&t?!!n.lastFiredCourseId:null!==(s=n.pausedAfterLastFire)&&void 0!==s&&s;return{...a,setup:{...n,paused:t,pausedAt:t?r:void 0,pausedAfterLastFire:l},lastActionAt:r}}))},[m]),eM=u.useCallback((e,t,r)=>{m(a=>a.map(a=>{var u;if(a.id!==e)return a;let s=null!==(u=a.setup)&&void 0!==u?u:d(a.pax||0);return{...a,setup:{...s,allergiesBySeat:{...s.allergiesBySeat,[t]:r}}}}))},[m]),e_=u.useCallback(e=>{var t;let r=null===(t=M.current.find(t=>t.id===e))||void 0===t?void 0:t.reservationId;m(t=>t.map(t=>{var r,a,u,l,i,o;if(t.id!==e||!t.setup)return t;let p=t.reservationId?_.current.find(e=>e.id===t.reservationId):null,f=null!==(a=null!==(r=t.reservationPax)&&void 0!==r?r:t.pax)&&void 0!==a?a:0,c=v(null!==(u=t.setup)&&void 0!==u?u:d(f));if(p){c=E(c,p.draftGuestSubs||[],p.draftGuestSeatMap||{});let e=p.draftMenuId||c.menuId||(null===(l=(0,s.ri)().menus[0])||void 0===l?void 0:l.id)||"m_a";if(c=R(c=function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},u=arguments.length>4?arguments[4]:void 0,s={...e.seatMenuId||{}};for(let e=1;e<=t;e++)s[e]||(s[e]=u);Object.keys(a).forEach(e=>{let t=r[e],u=a[e];t&&u&&(s[t]=u)});let l=n(s,t);for(let t of l){let r=e.courseLines.find(e=>e.idx===t.idx);r&&(t.status=r.status,t.refireCount=r.refireCount,t.hasRefired=r.hasRefired,t.seatSubs=r.seatSubs,t.firedAt=r.firedAt)}return{...e,menuId:s[1]||u,seatMenuId:s,courseLines:l}}(c,f,p.draftGuestSeatMap||{},{...p.draftGuestMenuMap||{},...p.draftGuestMenuId||{}},e),f,p.draftGuestSeatMap||{},p.draftGuestSubs||[],p.draftSetup),null===(i=p.draftSetup)||void 0===i?void 0:i.extrasByCourseId){let e={},t={};for(let[r,a]of(null===(o=p.draftSetup.courseLines)||void 0===o||o.forEach(e=>{e.id&&(t[e.id]=e.idx)}),Object.entries(p.draftSetup.extrasByCourseId||{}))){let u=t[r];if(!u)continue;let s=c.courseLines.find(e=>e.idx===u);s&&(e[s.id]=[...a])}c={...c,extrasByCourseId:e}}}return{...t,setup:{...c,approval:"PENDING"}}})),r&&o(e=>e.map(e=>e.id===r?{...e,sentToApproval:!0}:e))},[]),eL=u.useCallback(e=>{let t=Date.now();m(r=>r.map(r=>{if(r.id!==e)return r;let a=r.setup;return a?{...r,setup:{...a,approval:"APPROVED",approvedAt:t},lastActionAt:t}:r}))},[m]),ek=u.useCallback((e,t,r,a)=>{m(u=>u.map(u=>{var s;if(u.id!==e)return u;let n=null!==(s=u.setup)&&void 0!==s?s:d(u.pax||0);return{...u,setup:{...n,courseLines:n.courseLines.map(e=>e.id!==t?e:{...e,seatSubs:{...e.seatSubs,[r]:a}})}}}))},[m]),ex=u.useCallback((e,t,r)=>{m(a=>a.map(a=>{if(a.id!==e)return a;let u=a.setup;if(!u)return a;let s={...u,wineOverrideByCourseId:{...u.wineOverrideByCourseId||{},[t]:r}};return{...a,setup:s}}))},[m]),eG=u.useCallback((e,t)=>{m(r=>r.map(r=>r.id===e&&r.setup?{...r,setup:{...r.setup,fohNote:t}}:r))},[m]),ew=u.useCallback(e=>{m(t=>t.map(t=>t.id===e&&t.setup?{...t,setup:{...t.setup,wineMenuPassed:!t.setup.wineMenuPassed}}:t))},[m]),eP=u.useCallback(e=>{m(t=>t.map(t=>t.id===e&&t.setup?{...t,setup:{...t.setup,wineOrdered:!t.setup.wineOrdered}}:t))},[m]),eR=u.useCallback(e=>{let t=Date.now();m(r=>r.map(r=>{var a;if(r.id!==e)return r;let u=r.setup;if(!u||"APPROVED"!==u.approval||(a=u.lastFireAt)&&Date.now()-a<6e4)return r;if(u.paused){if(!u.pausedAfterLastFire||!u.lastFiredCourseId)return r;let e=u.lastFiredCourseId,a=u.courseLines.find(t=>t.id===e);if(!a||"FIRED"!==a.status||a.hasRefired)return r;let s=u.courseLines.map(r=>{var a;return r.id!==e?r:{...r,status:"FIRED",firedAt:t,refireCount:(null!==(a=r.refireCount)&&void 0!==a?a:0)+1,hasRefired:!0}});return{...r,setup:{...u,courseLines:s,lastFireAt:t,lastFiredAt:t,pausedAfterLastFire:!1},lastActionAt:t}}let s=u.courseLines.findIndex(e=>"PENDING"===e.status);if(-1===s)return r;let n=u.courseLines[s],l=u.courseLines.map((e,r)=>r===s?{...e,status:"FIRED",firedAt:t}:e);return{...r,setup:{...u,courseLines:l,lastFireAt:t,lastFiredAt:t,lastFiredCourseId:n.id,pausedAfterLastFire:!1},lastActionAt:t}}))},[m]),eF=u.useCallback((e,t)=>{let r=Date.now();m(a=>a.map(a=>{if(a.id!==e)return a;let u=a.setup;if(!u)return a;let s=u.courseLines.find(e=>e.id===t);return s&&"FIRED"===s.status?{...a,setup:{...u,courseLines:u.courseLines.map(e=>e.id===t?{...e,status:"DONE"}:e),lastDoneAt:r},lastActionAt:r}:a}))},[m]),eB=u.useCallback(e=>{switch(e.type){case"APPROVE_TABLE":eL(e.tableId);break;case"SET_SEAT_SUB":ek(e.tableId,e.courseId,e.seat,e.sub);break;case"FIRE_NEXT":eR(e.tableId);break;case"MARK_DONE":eF(e.tableId,e.courseId);break;case"TOGGLE_PAUSE":{let t=M.current.find(t=>t.id===e.tableId),r=null==t||!t.setup||!t.setup.paused;eg(e.tableId,r);break}case"ASSIGN_RES":X(e.reservation,e.tableId);break;case"SEAT_ASSIGNED":K(e.tableId);break;case"CLEAR_TABLE":Y(e.tableId);break;case"INSERT_COURSE":ey(e.tableId,e.anchorCourseId,e.where,e.name);break;case"MOVE_COURSE":eD(e.tableId,e.courseId,e.dir);break;case"DELETE_COURSE":eO(e.tableId,e.courseId);break;case"SET_SEAT_MENU":H(e.tableId,e.seat,e.menuId);break;case"SET_CHEF_NOTE":eA(e.tableId,e.note);break;case"ADD_EXTRA_DISH":eT(e.tableId,e.courseId,e.dishName);break;case"REMOVE_EXTRA_DISH":eh(e.tableId,e.courseId,e.index)}U()},[eL,X,Y,eR,ey,eF,eD,U,K,eg,ek,H,eA,eT,eh,eO]);u.useEffect(()=>{let e="OFF",t="";try{e=localStorage.getItem("tastingpos_lan_mode")||"OFF",t=localStorage.getItem("tastingpos_lan_host")||""}catch(e){}if(g.current=e,O(e),"OFF"===e||!t)return;let r=function(e,t){let r=null,a="DISCONNECTED",u=!1,s=e=>{var r;a=e,null===(r=t.onStatus)||void 0===r||r.call(t,e)},n=()=>{e&&(u=!1,s("CONNECTING"),(r=new WebSocket(e)).onopen=()=>s("CONNECTED"),r.onclose=()=>{s("DISCONNECTED"),r=null,u||setTimeout(n,800)},r.onerror=()=>{},r.onmessage=e=>{try{var r,a;let u=JSON.parse(e.data);"EVENT"===u.type&&(null===(r=t.onEvent)||void 0===r||r.call(t,u.payload)),"SNAPSHOT"===u.type&&(null===(a=t.onSnapshot)||void 0===a||a.call(t,u.payload))}catch(e){}})};return{connect:n,disconnect:()=>{u=!0,null==r||r.close(),r=null,s("DISCONNECTED")},send:e=>!!r&&1===r.readyState&&(r.send(JSON.stringify(e)),!0),getStatus:()=>a}}(t,{onStatus:h,onSnapshot:e=>{"CLIENT"===g.current&&B(e)},onEvent:e=>{"HOST"===g.current&&eB(e)}});return D.current=r,r.connect(),()=>r.disconnect()},[eB,B]);let eU=u.useCallback(e=>{if("CLIENT"===g.current){var t;null===(t=D.current)||void 0===t||t.send({type:"EVENT",payload:{type:"APPROVE_TABLE",tableId:e}});return}eL(e),U()},[eL,U]),eV=u.useCallback((e,t,r,a)=>{if("CLIENT"===g.current){var u;null===(u=D.current)||void 0===u||u.send({type:"EVENT",payload:{type:"SET_SEAT_SUB",tableId:e,courseId:t,seat:r,sub:a}});return}ek(e,t,r,a),U()},[U,ek]),ej=u.useCallback((e,t,r)=>{if("CLIENT"===g.current){var a;null===(a=D.current)||void 0===a||a.send({type:"EVENT",payload:{type:"SET_SEAT_MENU",tableId:e,seat:t,menuId:r}});return}H(e,t,r),U()},[U,H]),eH=u.useCallback((e,t)=>{if("CLIENT"===g.current){var r;null===(r=D.current)||void 0===r||r.send({type:"EVENT",payload:{type:"SET_CHEF_NOTE",tableId:e,note:t}});return}eA(e,t),U()},[U,eA]),eJ=u.useCallback((e,t,r)=>{if("CLIENT"===g.current){var a;null===(a=D.current)||void 0===a||a.send({type:"EVENT",payload:{type:"ADD_EXTRA_DISH",tableId:e,courseId:t,dishName:r}});return}eT(e,t,r),U()},[U,eT]),eX=u.useCallback((e,t,r)=>{if("CLIENT"===g.current){var a;null===(a=D.current)||void 0===a||a.send({type:"EVENT",payload:{type:"REMOVE_EXTRA_DISH",tableId:e,courseId:t,index:r}});return}eh(e,t,r),U()},[U,eh]),eK=u.useCallback(e=>{if("CLIENT"===g.current){var t;null===(t=D.current)||void 0===t||t.send({type:"EVENT",payload:{type:"FIRE_NEXT",tableId:e}});return}eR(e),U()},[eR,U]),eY=u.useCallback((e,t)=>{if("CLIENT"===g.current){var r;null===(r=D.current)||void 0===r||r.send({type:"EVENT",payload:{type:"MARK_DONE",tableId:e,courseId:t}});return}eF(e,t),U()},[eF,U]),eQ=u.useCallback((e,t)=>{if("CLIENT"===g.current){var r;null===(r=D.current)||void 0===r||r.send({type:"EVENT",payload:{type:"TOGGLE_PAUSE",tableId:e,paused:t}});return}eg(e,t),U()},[U,eg]),eW=u.useCallback((e,t)=>{if("CLIENT"===g.current){var r;null===(r=D.current)||void 0===r||r.send({type:"EVENT",payload:{type:"ASSIGN_RES",reservation:e,tableId:t}});return}X(e,t),U()},[X,U]),ez=u.useCallback(e=>{if("CLIENT"===g.current){var t;null===(t=D.current)||void 0===t||t.send({type:"EVENT",payload:{type:"SEAT_ASSIGNED",tableId:e}});return}K(e),U()},[U,K]),eq=u.useCallback(e=>{if("CLIENT"===g.current){var t;null===(t=D.current)||void 0===t||t.send({type:"EVENT",payload:{type:"CLEAR_TABLE",tableId:e}});return}Y(e),U()},[Y,U]),e$=u.useCallback((e,t,r,a)=>{if("CLIENT"===g.current){var u;null===(u=D.current)||void 0===u||u.send({type:"EVENT",payload:{type:"INSERT_COURSE",tableId:e,anchorCourseId:t,where:r,name:a}});return}ey(e,t,r,a),U()},[ey,U]),eZ=u.useCallback((e,t,r)=>{if("CLIENT"===g.current){var a;null===(a=D.current)||void 0===a||a.send({type:"EVENT",payload:{type:"MOVE_COURSE",tableId:e,courseId:t,dir:r}});return}eD(e,t,r),U()},[eD,U]),e0=u.useCallback((e,t)=>{if("CLIENT"===g.current){var r;null===(r=D.current)||void 0===r||r.send({type:"EVENT",payload:{type:"DELETE_COURSE",tableId:e,courseId:t}});return}eO(e,t),U()},[eO,U]),e1=u.useCallback(e=>{var t;let r=null===(t=e.setup)||void 0===t?void 0:t.allergiesBySeat;return!!r&&Object.values(r).some(e=>(e||"").trim().length>0)},[]),e2=u.useCallback(e=>{var t;let r=null===(t=e.setup)||void 0===t?void 0:t.courseLines;if(!r||0===r.length)return null;let a=[...r].reverse().find(e=>"FIRED"===e.status);if(a)return a.idx;let u=r.find(e=>"PENDING"===e.status);return u?u.idx:null},[]),e6=u.useCallback(e=>{var t;let r=null===(t=e.setup)||void 0===t?void 0:t.lastFireAt;if(!r)return 0;let a=Math.ceil((6e4-(Date.now()-r))/1e3);return a>0?a:0},[]);return(0,a.jsx)(c.Provider,{value:{reservations:r,tables:b,setReservations:o,setTables:m,getReservationById:G,getDraftForReservation:w,getEffectiveDraftSetupForTable:F,coursePresetSubs:N,lanStatus:T,lanMode:y,setMenuForTable:j,setPairing:J,setPaused:eQ,setAllergy:eM,setWineOverride:ex,setFohNote:eG,toggleWineMenuPassed:ew,toggleWineOrdered:eP,assignReservationToTable:eW,seatAssignedTable:ez,clearReservationFromTable:eq,updateReservation:Q,updateReservationNote:W,addReservation:z,deleteReservation:q,createDraftForReservation:Z,markDraftPrepared:ee,clearDraft:et,draftInsertCourse:er,draftDeleteCourse:ea,draftMoveCourse:eu,draftSetSeatSub:es,draftAddExtraDish:en,draftRemoveExtraDish:el,draftSetChefNote:ei,draftAddGuestSub:ec,draftRemoveGuestSub:ev,draftAssignGuestToSeat:eS,draftSetGuestMenu:eE,draftEditCourseText:eb,draftAddCourse:em,setDraftMenu:eC,setDraftGuestMenu:eI,setTableLanguage:eN,setSeatMenu:ej,dishPresets:A,setChefNote:eH,addExtraDish:eJ,removeExtraDish:eX,insertCourseLine:e$,deleteCourseLine:e0,moveCourseLine:eZ,kitchenEditCourseText:ed,kitchenMoveCourse:eo,kitchenDeleteCourse:ep,kitchenAddCourse:ef,sendForApproval:e_,approveTable:eU,setSeatSub:eV,fireNextOrRefire:eK,markDone:eY,hasAllergyFlag:e1,getOnCourse:e2,getFireCooldownSeconds:e6},children:t})}function m(){let e=u.useContext(c);if(!e)throw Error("useAppState must be used within AppStateProvider");return e}function C(e,t){let r=[],a=e.setup;if("SEATED"===e.reservationStatus){let u=e.seatedAt?t-e.seatedAt:0;a&&"APPROVED"!==a.approval&&r.push("NEEDS_APPROVAL"),(null==a?void 0:a.paused)&&a.pausedAt&&t-a.pausedAt>6e5&&r.push("PAUSED_TOO_LONG"),(null==a?void 0:a.lastFiredAt)||!(u>9e5)||r.push("SEATED_TOO_LONG_NO_FIRE"),(null==a?void 0:a.lastFiredAt)&&(!(null==a?void 0:a.lastDoneAt)||a.lastDoneAt<a.lastFiredAt)&&t-a.lastFiredAt>72e4&&r.push("FIRED_TOO_LONG_NO_DONE")}return r}function N(e,t){let r=C(e,t),a=0;for(let e of r)"NEEDS_APPROVAL"===e&&(a+=80),"PAUSED_TOO_LONG"===e&&(a+=70),"SEATED_TOO_LONG_NO_FIRE"===e&&(a+=60),"FIRED_TOO_LONG_NO_DONE"===e&&(a+=55);return e.seatedAt&&(a+=Math.min(40,Math.floor((t-e.seatedAt)/3e5))),a}},7188:function(e,t,r){r.d(t,{$J:function(){return d},F:function(){return i},hQ:function(){return s},ri:function(){return n},zQ:function(){return l}});let a="tastingpos_settings_v1",u={version:1,menus:[{id:"m_a",label:"Classic",courses:["Amuse","Oyster","Tomato Water","Scallop","Caviar","Langoustine","Turbot","Pigeon","Pre-dessert","Chocolate","Mignardises"]},{id:"m_b",label:"Seasonal",courses:["Amuse","Gazpacho","Citrus","Foie Gras","Truffle Pasta","Lobster","Wagyu","Cheese","Pre-dessert","Apple","Mignardises"]}],tableLanguages:["ING","CAST","CAT"],dishPresets:["Vegetarian extra","Fish alternative","No dairy alternative","Gluten-free bread","Extra sauce","Extra garnish","Chef snack"],subsPresets:["Vegetarian Alternative","No Shellfish Alternative","No Dairy Alternative","Gluten-Free Alternative","Chef Special Substitute"],wines:[{id:"w1",name:"House Sparkling"},{id:"w2",name:"White Pairing 1"},{id:"w3",name:"Red Pairing 1"}],pairing:[{id:"p1",menuId:"m_a",wineId:"w1",fromIdx:1,toIdx:2}]};function s(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"id";return"".concat(e,"_").concat(Math.random().toString(36).slice(2),"_").concat(Date.now().toString(16))}function n(){let e=localStorage.getItem(a);if(!e)return u;try{var t,r,s,n;let a=JSON.parse(e);if(!a||"object"!=typeof a)return u;let l=Array.isArray(a.menus)?a.menus:u.menus,i=Array.isArray(a.pairing)?a.pairing.map(e=>e.menuId?e:"A"===e.menu?{...e,menuId:"m_a"}:"B"===e.menu?{...e,menuId:"m_b"}:null).filter(Boolean):u.pairing;return{...u,...a,menus:l,tableLanguages:null!==(t=a.tableLanguages)&&void 0!==t?t:u.tableLanguages,dishPresets:null!==(r=a.dishPresets)&&void 0!==r?r:u.dishPresets,subsPresets:null!==(s=a.subsPresets)&&void 0!==s?s:u.subsPresets,wines:null!==(n=a.wines)&&void 0!==n?n:u.wines,pairing:i}}catch(e){return u}}function l(e){localStorage.setItem(a,JSON.stringify(e))}function i(e){return n().menus.find(t=>t.id===e)||null}function d(e,t){let r=n(),a=r.pairing.find(r=>r.menuId===e&&t>=r.fromIdx&&t<=r.toIdx);if(!a)return null;let u=r.wines.find(e=>e.id===a.wineId);return u?{wineName:u.name,ruleId:a.id}:null}}}]);